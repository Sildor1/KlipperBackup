[include mainsail.cfg]
[include macros.cfg]
# Klipper Konfiguration für Anet A8 Plus mit BTT SKR mini E3 V2.0
# Ohne BLTouch und ohne Bed Leveling
# Z-Homing in der Mitte des Druckbetts

# Dieses File enthält die Pin-Zuweisungen für das BIGTREETECH SKR mini E3 v2.0.
# Zum Kompilieren der Firmware:
# - STM32F103 Microcontroller auswählen
# - "28KiB bootloader" auswählen
# - USB communication auswählen
# - "Enable extra low-level configuration options" aktivieren
# - "GPIO pins to set at micro-controller startup" auf "!PA14" setzen

# Nach dem Kompilieren (make) die generierte "out/klipper.bin" Datei
# auf eine SD-Karte als "firmware.bin" kopieren und das Board damit neustarten.

# Siehe docs/Config_Reference.md für eine Beschreibung der Parameter.

#####################################################################
# MCU (Microcontroller Unit) Einstellungen
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_33FFD6055356343527501543-if00
# WICHTIG: Ersetzen Sie XXXXXX mit Ihrer tatsächlichen Serial-ID
# Finden mit: ls /dev/serial/by-id/*

#####################################################################
# X-Achsen Stepper Motor Einstellungen
#####################################################################

[stepper_x]
step_pin: PB13
dir_pin: !PB12
enable_pin: !PB14
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PC0
position_endstop: -20
position_min: -20
position_max: 300
homing_speed: 50

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
run_current: 0.580
stealthchop_threshold: 999999

#####################################################################
# Y-Achsen Stepper Motor Einstellungen
#####################################################################

[stepper_y]
step_pin: PB10
dir_pin: !PB2
enable_pin: !PB11
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PC1
position_endstop: -4.5
position_min: -4.5
position_max: 300
homing_speed: 50

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.580
stealthchop_threshold: 999999

#####################################################################
# Z-Achsen Stepper Motor Einstellungen
#####################################################################

[stepper_z]
step_pin: PB0
dir_pin: !PC5
enable_pin: !PB1
microsteps: 16
rotation_distance: 8
endstop_pin: ^!PC2
position_endstop: 0.0
position_max: 350
position_min: -2
homing_speed: 10

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 0.580
stealthchop_threshold: 999999

#####################################################################
# Extruder Einstellungen
#####################################################################

[extruder]
step_pin: PB3
dir_pin: PB4
enable_pin: !PD2
microsteps: 16
rotation_distance: 33.600
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC8
sensor_type: Generic 3950
sensor_pin: PA0
control: pid
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp: 0
max_temp: 250

[tmc2209 extruder]
uart_pin: PC11
tx_pin: PC10
uart_address: 3
run_current: 0.650
stealthchop_threshold: 999999

#####################################################################
# Heizbett Einstellungen
#####################################################################

[heater_bed]
heater_pin: PC9
sensor_type: Generic 3950
sensor_pin: PC3
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: 0
max_temp: 110


#####################################################################
# Lüfter Einstellungen
#####################################################################

# Part Cooling Fan (Teile-Lüfter)
[fan]
pin: PC6

# Hotend Fan (Heatbreak-Lüfter)
[heater_fan heatbreak_cooling_fan]
pin: PC7

#####################################################################
# Board-spezifische Einstellungen für SKR mini E3 V2.0
#####################################################################

[static_digital_output usb_pullup_enable]
pins: !PA14

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PB5,  EXP1_3=PA9,   EXP1_5=PA10, EXP1_7=PB8, EXP1_9=<GND>,
    EXP1_2=PA15, EXP1_4=<RST>, EXP1_6=PB9,  EXP1_8=PB15, EXP1_10=<5V>

#####################################################################
# Safe Z-Homing (Homing in der Mitte des Druckbetts)
#####################################################################

[safe_z_home]
home_xy_position: 150, 150  # Mitte des Druckbetts (300/2, 300/2)
speed: 50
z_hop: 10                    # Hebt Z um 10mm vor XY-Bewegung
z_hop_speed: 5

#####################################################################
# Drucker Kinematik und Geschwindigkeitseinstellungen
#####################################################################

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 1000
max_z_velocity: 20
max_z_accel: 100

#####################################################################
# Display Einstellungen (LCD 12864)
#####################################################################

[display]
lcd_type: st7920
cs_pin: EXP1_7
sclk_pin: EXP1_6
sid_pin: EXP1_8
encoder_pins: ^EXP1_5, ^EXP1_3
click_pin: ^!EXP1_2

[output_pin beeper]
pin: EXP1_1

#####################################################################
# Optionale Einstellungen
#####################################################################

# Manuelle Bed Leveling Schrauben (für manuelle Einstellung)
# Kommentieren Sie diese Sektion ein, wenn Sie manuelle Bed-Leveling-Hilfe wünschen
# [bed_screws]
# screw1: 30, 30
# screw1_name: Vorne Links
# screw2: 270, 30
# screw2_name: Vorne Rechts
# screw3: 270, 270
# screw3_name: Hinten Rechts
# screw4: 30, 270
# screw4_name: Hinten Links

# Virtual SD Card für direktes Drucken von der SD-Karte
[virtual_sdcard] 
path: /home/klipper/printer_Anet_data/gcodes


# Pause/Resume Funktionalität
[pause_resume]

# Display Status für Mainsail/Fluidd
[display_status]

#####################################################################
# WICHTIGE HINWEISE FÜR BTT SKR MINI E3 V2.0
#####################################################################

# 1. FIRMWARE KOMPILIEREN
#    Beim Kompilieren der Klipper-Firmware wählen Sie:
#    - Micro-controller Architecture: STMicroelectronics STM32
#    - Processor model: STM32F103
#    - Bootloader offset: 28KiB bootloader
#    - Communication interface: USB (on PA11/PA12)
#    - GPIO pins to set at micro-controller startup: !PA14
#
# 2. FIRMWARE FLASHEN
#    Das SKR mini E3 V2.0 unterstützt NICHT den "make flash" Befehl.
#    Nach dem Kompilieren:
#    - Kopieren Sie "out/klipper.bin" auf eine SD-Karte
#    - Benennen Sie die Datei um zu "firmware.bin"
#    - Stecken Sie die SD-Karte in das Board
#    - Schalten Sie den Drucker ein - die Firmware wird automatisch geflasht
#    - Die Status-LED blinkt rot während des Updates (ca. 10 Sekunden)
#
# 3. SERIELLE VERBINDUNG
#    Nach dem Flashen finden Sie die serielle ID mit:
#    ls /dev/serial/by-id/*
#    Kopieren Sie die vollständige ID und ersetzen Sie XXXXXX in [mcu]
#
# 4. TMC2209 TREIBER
#    Das Board hat onboard TMC2209 Treiber im UART-Modus.
#    Diese bieten:
#    - 256 Microsteps (extrem präzise)
#    - StealthChop für leisen Betrieb
#    - Keine zusätzlichen Jumper erforderlich
#
# 5. SAFE Z HOMING
#    Diese Konfiguration verwendet [safe_z_home] um Z-Achse in der Mitte
#    des Druckbetts zu homen (Position 150,150 mm).
#    Vorteile:
#    - Vermeidet Endstop-Trigger außerhalb des Druckbereichs
#    - Sicherer für mechanische Endstops
#    - z_hop hebt die Düse vor XY-Bewegungen an
#
# 6. PID-TUNING
#    Die PID-Werte für Extruder und Heizbett sind Standardwerte.
#    Führen Sie ein PID-Tuning für optimale Ergebnisse durch:
#    Extruder: PID_CALIBRATE HEATER=extruder TARGET=200
#    Heizbett: PID_CALIBRATE HEATER=heater_bed TARGET=60
#    Speichern Sie mit: SAVE_CONFIG
#
# 7. ROTATION_DISTANCE KALIBRIERUNG
#    Der rotation_distance-Wert für den Extruder (33.600) ist ein Startwert.
#    Kalibrieren Sie diesen Wert für präzise Extrusionsmengen.
#
# 8. Z-OFFSET
#    Der position_endstop für die Z-Achse (0.5) muss möglicherweise angepasst werden.
#    Verwenden Sie das Paper-Test-Verfahren zur Feineinstellung.
#
# 9. STROMSTÄRKEN (run_current)
#    Die Standardwerte sind:
#    - X/Y/Z: 0.580 A
#    - Extruder: 0.650 A
#    Diese können bei Bedarf angepasst werden (max. 1.2A für TMC2209)
#
# 10. SLICER-EINSTELLUNGEN
#     In Ihrem Slicer (Cura, PrusaSlicer, etc.):
#     Start G-Code: START_PRINT
#     End G-Code: END_PRINT

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 73.988
#*# pid_ki = 1.330
#*# pid_kd = 1029.359
